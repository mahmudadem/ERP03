# ERP-Enhanced â€” Master Architecture Roadmap

## PHASE 1 â€” Routing & Core Architecture Hygiene
### ðŸŽ¯ Objective
Establish strict separation between Platform (Super Admin) and Tenant (Company) layers to secure the application and prepare for modularity. Fix immediate architectural violations like direct controller instantiation.

### ðŸ›  Tasks
1.  **Split Global Router**: Decompose [backend/src/api/server/router.ts](file:///c:/Users/KG/OneDrive/Desktop/ERP03/backend/src/api/server/router.ts) into three distinct routers: `PlatformRouter` (Super Admin), `TenantRouter` (Company Context), and `PublicRouter` (Auth/Wizard).
2.  **Enforce Context Middleware**: Apply strict middleware to `TenantRouter` that validates `companyId` and ensures the module is enabled for that company.
3.  **Refactor CompanyController**: Remove direct `new FirestoreCompanyRepository()` instantiation in [CompanyController.ts](file:///c:/Users/KG/OneDrive/Desktop/ERP03/backend/src/api/controllers/CompanyController.ts) and replace it with `diContainer` injection.
4.  **Standardize Repository Base**: Review `BaseFirestoreRepository` to ensure it doesn't leak Firestore types into the domain, or wrap it in a generic interface.

### âœ” Development Checklist 
[ ] Split router.ts into Platform, Tenant, and Public routers â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Implement TenantContextMiddleware for company routes â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Refactor CompanyController to use Dependency Injection â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Update api/index.ts to mount new routers correctly â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±

### ðŸ§ª Testing Checklist
[ ] Verify Super Admin routes return 403/404 for normal users â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨
[ ] Verify Company routes fail without valid companyId header â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨
[ ] Verify Company creation flow works with new DI implementation â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨
[ ] Run existing API smoke tests to ensure no regression â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨

---

## PHASE 2 â€” Platform Layer (Permissions, Flags, Bundles)
### ðŸŽ¯ Objective
Build the "Brain" of the SaaS platform. Move away from dynamic, database-stored permission definitions to a hard-coded, version-controlled Source of Truth. Implement Feature Flags and Bundles to control feature access.

### ðŸ›  Tasks
1.  **Static Permission Catalog**: Create `src/config/PermissionCatalog.ts` defining all system permissions and roles.
2.  **Permission Sync Service**: Build a service to sync the Static Catalog to Firestore (read-only for Admin) on startup.
3.  **Feature Flag Engine**: Implement a lightweight `FeatureFlagService` that checks `GlobalConfig` (Platform level) and `CompanySettings` (Tenant level).
4.  **Bundle Definitions**: Define `Bundle` types (e.g., "Starter", "Pro", "Enterprise") in code, mapping them to specific Modules and Feature Flags.

### âœ” Development Checklist ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±)
[ ] Create PermissionCatalog.ts with all existing permissions â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Implement PermissionSyncService â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Create FeatureFlagService and integration points â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Define Bundle types and logic in Domain layer â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±

### ðŸ§ª Testing Checklist (ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ Ø§Ù„ÙƒØ§Ù…Ù„)
[ ] Verify permissions sync to Firestore on server start â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨
[ ] Verify feature flags correctly hide/show functionality â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨
[ ] Test assigning a Bundle to a Company and checking access â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨

---

## PHASE 3 â€” Module Registry & Isolation
### ðŸŽ¯ Objective
Transform "folders with routes" into a true Module System. Modules must register themselves with the Platform, declaring their dependencies, permissions, and routes.

### ðŸ›  Tasks
1.  **Module Interface**: Define `IModule` interface (id, name, routes, permissions, requiredBundles).
2.  **Module Registry**: Create `ModuleRegistry` singleton to hold loaded modules.
3.  **Refactor Existing Modules**: Convert Accounting, Inventory, HR, etc., to implement `IModule`.
4.  **Dynamic Route Mounting**: Update `TenantRouter` to iterate over `ModuleRegistry` and mount routes dynamically based on enabled modules.

### âœ” Development Checklist (ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±)
[ ] Define IModule interface â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Implement ModuleRegistry class â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Refactor Accounting module to register via IModule â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Refactor Inventory module to register via IModule â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Update TenantRouter to mount routes from Registry â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±

### ðŸ§ª Testing Checklist (ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ Ø§Ù„ÙƒØ§Ù…Ù„)
[ ] Verify Accounting routes are accessible only if module is enabled â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨
[ ] Verify Inventory routes are accessible only if module is enabled â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨
[ ] Verify disabling a module immediately revokes API access â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨

---

## PHASE 4 â€” Company Wizard & Onboarding
### ðŸŽ¯ Objective
Move the Company Creation Wizard out of the Super Admin domain. Ensure it is owned by the User/Client and correctly integrates with the new Bundles and Permission systems.

### ðŸ›  Tasks
1.  **Relocate Wizard**: Move `super-admin.company-wizard` logic to `application/onboarding` or `core`.
2.  **Update API Routes**: Expose Wizard via `PublicRouter` (authenticated user, no company yet) or `CoreRouter`.
3.  **Bundle Selection**: Update Wizard to allow selecting a `Bundle` (Starter/Pro) instead of raw modules.
4.  **Template Application**: Ensure Wizard applies the correct `PermissionCatalog` roles based on the selected Bundle.

### âœ” Development Checklist (ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±)
[ ] Move Wizard Controller and Use Cases to Core/Onboarding â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Update Wizard API routes in PublicRouter â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Integrate Bundle selection into Wizard flow â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Update Frontend Wizard to use new API endpoints â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±

### ðŸ§ª Testing Checklist (ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ Ø§Ù„ÙƒØ§Ù…Ù„)
[ ] Verify a new user can create a company without Super Admin rights â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨
[ ] Verify selected Bundle correctly enables modules â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨
[ ] Verify default roles are created correctly from Catalog â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨

---

## PHASE 5 â€” Designer System Refactor
### ðŸŽ¯ Objective
Eliminate the generic global designer. Implement specific, type-safe designers for modules (e.g., Voucher Designer) that are aware of the module's schema.

### ðŸ›  Tasks
1.  **Delete Global Designer**: Remove the generic `/designer` route and associated generic engine code.
2.  **Scaffold Module Designer**: Create `AccountingVoucherDesigner` in the Accounting module frontend.
3.  **Schema Integration**: Connect the designer to the [Voucher](file:///c:/Users/KG/OneDrive/Desktop/ERP03/backend/src/domain/accounting/entities/Voucher.ts#3-30) schema/DTOs to ensure field validity.
4.  **Scoped API**: Create backend endpoints specifically for `accounting/designers/voucher`.

### âœ” Development Checklist (ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±)
[ ] Remove global designer routes and code â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Implement AccountingVoucherDesigner UI â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Create backend API for saving Voucher layouts â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Integrate Designer into Accounting Settings menu â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±

### ðŸ§ª Testing Checklist (ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ Ø§Ù„ÙƒØ§Ù…Ù„)
[ ] Verify Designer loads correct Voucher fields â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨
[ ] Verify saved layout is applied to Voucher Print/View â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨
[ ] Verify non-accounting users cannot access the designer â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨

---

## PHASE 6 â€” SQL Migration Infrastructure
### ðŸŽ¯ Objective
Prepare the codebase for a switch to PostgreSQL. Implement the SQL repositories parallel to Firestore repositories using the defined interfaces.

### ðŸ›  Tasks
1.  **ORM Setup**: Install and configure Prisma or TypeORM.
2.  **SQL Schema**: Define SQL schema matching the Domain Entities (normalized).
3.  **SQL Repositories**: Implement `SqlCompanyRepository`, `SqlVoucherRepository`, etc.
4.  **SQL Mappers**: Create Mappers to translate between SQL Rows and Domain Entities (handling joins/normalization).
5.  **Config Switch**: Update [bindRepositories.ts](file:///c:/Users/KG/OneDrive/Desktop/ERP03/backend/src/infrastructure/di/bindRepositories.ts) to switch implementations based on `process.env.DB_TYPE`.

### âœ” Development Checklist (ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±)
[ ] Setup ORM and define initial schema â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Implement SqlCompanyRepository â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Implement SqlVoucherRepository (with normalized lines) â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Create SQL Migration Scripts (Firestore -> SQL) â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±
[ ] Add DB_TYPE switch in Dependency Injection container â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ·ÙˆÙŠØ±

### ðŸ§ª Testing Checklist (ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ Ø§Ù„ÙƒØ§Ù…Ù„)
[ ] Verify application boots with DB_TYPE=SQL â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨
[ ] Verify CRUD operations work identically on SQL â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨
[ ] Verify complex queries (Vouchers with Lines) return correct data â€” ØªÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨

---

## ðŸ“Œ GLOBAL PROGRESS SUMMARY

| Phase | Dev % | Test % |
|-------|--------|---------|
| Phase 1 â€” Routing & Core Hygiene | 0% | 0% |
| Phase 2 â€” Platform Layer | 0% | 0% |
| Phase 3 â€” Module Registry | 0% | 0% |
| Phase 4 â€” Company Wizard | 0% | 0% |
| Phase 5 â€” Designer System | 0% | 0% |
| Phase 6 â€” SQL Infrastructure | 0% | 0% |
