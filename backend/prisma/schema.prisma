// Prisma schema for ERP-Enhanced
// This defines the SQL database structure

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core Entities
model Company {
  id              String   @id
  name            String
  ownerId         String
  taxId           String   @unique
  address         String?
  country         String?
  logoUrl         String?
  subscriptionPlan String?
  contactInfo     Json?
  baseCurrency    String
  fiscalYearStart DateTime
  fiscalYearEnd   DateTime
  modules         String[] // Array of enabled module IDs
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  users           CompanyUser[]
  accounts        Account[]
  vouchers        Voucher[]
  roles           CompanyRole[]

  @@index([ownerId])
  @@map("companies")
}

model User {
  id        String   @id
  email     String   @unique
  name      String?
  role      String   @default("USER")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  companies CompanyUser[]

  @@map("users")
}

model CompanyUser {
  userId    String
  companyId String
  roleId    String
  isOwner   Boolean  @default(false)
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@id([userId, companyId])
  @@map("company_users")
}

model CompanyRole {
  id                  String   @id
  companyId           String
  name                String
  moduleBundles       String[] // Array of bundle IDs
  resolvedPermissions String[] // Array of permission IDs
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name])
  @@map("company_roles")
}

// ============================================
// Currency & Exchange Rate Models
// ============================================

// Global Currency Definition
// Currency properties are fixed globally - companies enable/disable but cannot modify
model Currency {
  code          String   @id        // ISO 4217 code (e.g., "USD", "EUR", "JPY")
  name          String              // Display name (e.g., "US Dollar")
  symbol        String              // Currency symbol (e.g., "$", "€", "¥")
  decimalPlaces Int      @default(2) // 0 for JPY, 3 for BHD/KWD, 2 for most
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  companyCurrencies CompanyCurrency[]

  @@map("currencies")
}

// Company-enabled currencies (join table)
// Only tracks enable/disable state - rate history stored in ExchangeRate
model CompanyCurrency {
  id           String   @id @default(uuid())
  companyId    String
  currencyCode String
  isEnabled    Boolean  @default(true)
  enabledAt    DateTime @default(now())
  disabledAt   DateTime?

  currency Currency @relation(fields: [currencyCode], references: [code])

  @@unique([companyId, currencyCode])
  @@index([companyId])
  @@map("company_currencies")
}

// Exchange Rate Reference Store
// Stores historical rates for lookup and suggestions
// NO unique constraint on (companyId, fromCurrency, toCurrency, date) - allows multiple rates per day
model ExchangeRate {
  id           String   @id @default(uuid())
  companyId    String
  fromCurrency String   // Source currency code
  toCurrency   String   // Target currency code (typically base currency)
  rate         Float    // Exchange rate value
  date         DateTime // Effective date (date only, time ignored)
  source       String   @default("MANUAL") // MANUAL | REFERENCE
  createdAt    DateTime @default(now())
  createdBy    String?  // User who entered the rate

  @@index([companyId, fromCurrency, toCurrency, date])
  @@index([companyId, date])
  @@map("exchange_rates")
}

// Accounting Module - Chart of Accounts
model Account {
  id                    String   @id @default(uuid())
  companyId             String
  
  // Identity
  systemCode            String   // Auto-generated, immutable (ACC-000001)
  userCode              String   // User-editable, unique per company
  name                  String
  description           String?
  
  // Accounting semantics
  accountRole           String   @default("POSTING") // HEADER | POSTING
  classification        String   // ASSET | LIABILITY | EQUITY | REVENUE | EXPENSE
  balanceNature         String   @default("DEBIT")   // DEBIT | CREDIT | BOTH
  balanceEnforcement    String   @default("WARN_ABNORMAL") // ALLOW_ABNORMAL | WARN_ABNORMAL | BLOCK_ABNORMAL
  
  // Hierarchy
  parentId              String?
  
  // Currency policy
  currencyPolicy        String   @default("INHERIT") // INHERIT | FIXED | OPEN | RESTRICTED
  fixedCurrencyCode     String?
  allowedCurrencyCodes  String[] @default([])
  
  // Lifecycle
  status                String   @default("ACTIVE") // ACTIVE | INACTIVE
  isProtected           Boolean  @default(false)
  replacedByAccountId   String?
  
  // Audit
  createdAt             DateTime @default(now())
  createdBy             String
  updatedAt             DateTime @updatedAt
  updatedBy             String

  // Relations
  company               Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lines                 VoucherLine[]

  @@unique([companyId, systemCode])
  @@unique([companyId, userCode])
  @@index([companyId, classification])
  @@index([companyId, status])
  @@index([companyId, parentId])
  @@map("accounts")
}

model Voucher {
  id               String   @id
  companyId        String
  type             String
  voucherNo        String?
  date             DateTime
  currency         String
  baseCurrency     String
  exchangeRate     Float    @default(1.0)
  status           String
  totalDebit       Float    @default(0) // Total base currency debits
  totalCredit      Float    @default(0) // Total base currency credits
  createdBy        String
  approvedBy       String?
  lockedBy         String?
  reference        String?
  description      String?
  metadata         Json?    @default("{}")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  company Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lines   VoucherLine[]

  @@index([companyId, date])
  @@index([companyId, status])
  @@map("vouchers")
}

model VoucherLine {
  id           String  @id
  voucherId    String
  accountId    String
  description  String?
  side         String  // "Debit" or "Credit"
  amount       Float   @default(0) // Transaction currency amount
  baseAmount   Float   @default(0) // Base currency amount
  currency     String  // Transaction currency code
  baseCurrency String  // Base currency code (company base)
  exchangeRate Float   @default(1.0)
  costCenterId String?
  metadata     Json?    @default("{}")

  voucher Voucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id])

  @@index([voucherId])
  @@index([accountId])
  @@map("voucher_lines")
}

// Inventory Module
model Item {
  id          String   @id
  companyId   String
  code        String
  name        String
  description String?
  category    String?
  unit        String
  price       Float    @default(0)
  cost        Float    @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyId, code])
  @@map("items")
}

// HR Module
model Employee {
  id         String   @id
  companyId  String
  code       String
  firstName  String
  lastName   String
  email      String?
  phone      String?
  position   String?
  department String?
  salary     Float?
  hireDate   DateTime
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([companyId, code])
  @@map("employees")
}
